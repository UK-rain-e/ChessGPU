var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1,min:.05,max:.5,precision:2,description:"Controls the movement speed"}),Movement.prototype.initialize=function(){this.force=new pc.Vec3},Movement.prototype.update=function(e){if(void 0!==this.entity.rigidbody){var t=0,s=0,i=0;if(this.app.keyboard.isPressed(pc.KEY_M),this.app.keyboard.isPressed(pc.KEY_LEFT)&&(t=-this.speed),this.app.keyboard.isPressed(pc.KEY_RIGHT)&&(t+=this.speed),this.app.keyboard.isPressed(pc.KEY_UP)&&(s=-this.speed),this.app.keyboard.isPressed(pc.KEY_DOWN)&&(s+=this.speed),this.app.keyboard.isPressed(pc.KEY_SPACE)&&this.entity.getPosition().y<.051&&(i=50*this.speed),this.force.x=t,this.force.z=s,this.force.length()){var o=Math.cos(.25*-Math.PI),p=Math.sin(.25*-Math.PI);this.force.set(this.force.x*o-this.force.z*p,0,this.force.z*o+this.force.x*p),this.force.length()>this.speed&&this.force.normalize().scale(this.speed)}this.force.y=i,this.entity.rigidbody.applyImpulse(this.force)}};var MainCameraController=pc.createScript("mainCameraController");MainCameraController.attributes.add("moveSpeed",{type:"number",default:.003}),MainCameraController.attributes.add("enableCinematic",{type:"boolean",default:!1}),MainCameraController.prototype.getDistance=function(t,e){var i=e.x-t.x,o=e.y-t.y,s=e.z-t.z;return Math.sqrt(i*i+o*o+s*s)},MainCameraController.prototype.initialize=function(){this.mouseDown=!1,this.camera=this.entity.camera,this.target=new pc.Vec3(0,0,0),this.scrollSpeed=.5,this.phi=Math.atan(this.entity.getPosition().x/this.entity.getPosition().z),this.startTime=Date.now(),this.hypotenuse=this.getDistance(new pc.Vec3(0,0,0),new pc.Vec3(this.entity.getPosition().x,0,this.entity.getPosition().z)),this.theta=Math.atan(this.entity.getPosition().y/this.hypotenuse),this.distance=this.getDistance(this.entity.getPosition(),this.target),this.enableCinematic&&this.cinematicFlyInit(),console.log(this.positionCurves),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this)},MainCameraController.prototype.onMouseDown=function(t){t.button===pc.MOUSEBUTTON_LEFT&&(this.mouseDown=!0)},MainCameraController.prototype.onMouseUp=function(t){t.button===pc.MOUSEBUTTON_LEFT&&(this.mouseDown=!1)},MainCameraController.prototype.onMouseMove=function(t){if(this.mouseDown){var e=t.dx,i=t.dy;this.theta+=i*this.moveSpeed;this.theta=pc.math.clamp(this.theta,-Math.PI/2,Math.PI/2),(this.phi-=e*this.moveSpeed)>-Math.phi&&(this.theta=pc.math.clamp(this.theta,-Math.PI/2,Math.PI/2)),this.updateCameraPosition(),this.entity.lookAt(0,0,0,0,1,0)}},MainCameraController.prototype.onMouseWheel=function(t){this.distance-=t.wheel*this.scrollSpeed,this.distance=pc.math.clamp(this.distance,1,100),this.updateCameraPosition()},MainCameraController.prototype.updateCameraPosition=function(){var t=this.distance*Math.sin(this.phi)*Math.cos(this.theta),e=this.distance*Math.sin(this.theta),i=this.distance*Math.cos(this.phi)*Math.cos(this.theta);this.entity.setPosition(this.target.x+t,this.target.y+e,this.target.z+i)},MainCameraController.prototype.cinematicFlyInit=function(){this.positionCurves=new pc.CurveSet([[0,4,.66,1,1.33,1,2,-1],[0,1,.66,1,1.33,1,2,1],[0,3,.66,3,1.33,4.5,2,4.5]]),this.positionCurves.type=pc.CURVE_SPLINE,this.rotationCurves=new pc.CurveSet([[0]]),console.log("init curve finish")},MainCameraController.prototype.update=function(t){if(this.enableCinematic){var e=Date.now()-this.startTime,i=this.positionCurves.value(e/1e3);this.entity.setPosition(i[0],i[1],i[2])}this.timeSinceStart};var MousePick=pc.createScript("mousePick");MousePick.prototype.initialize=function(){this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onSelect,this),this.app.mouse.disableContextMenu(),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onSelect,this)}),this),this.currentPicked=null,this.currentPickedStartTime=null,this.currentPickedCurve=null,this.duration=5,this.mousePicker=!0,this.chessPickCallback=e=>{},this.isNuking=!1,this.nukeOldRot=null},MousePick.prototype.setChessPickCallback=function(e){this.chessPickCallback=e},MousePick.prototype.onSelect=function(e){if(e.button===pc.MOUSEBUTTON_LEFT){var t=this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.nearClip),i=this.entity.camera.screenToWorld(e.x,e.y,this.entity.camera.farClip),n=this.app.systems.rigidbody.raycastFirst(t,i);if(n)if("BigRedButton"!==n.entity.name)if("board"!==n.entity.parent.parent.name){if("pieces"===n.entity.parent.name&&null===this.currentPicked){this.chessPickCallback(n.entity);var r=n.entity.getLocalPosition();if(!(r.z>-3.7)){var s=new pc.Vec3(r.x,r.y,r.z+10);this.currentPickedCurve=new pc.CurveSet([[0,r.x,this.duration,s.x],[0,r.y,this.duration,s.y],[0,r.z,this.duration,s.z]]),this.currentPicked=n.entity,this.currentPickedStartTime=Date.now(),n.entity.rigidbody.enabled=!1,n.entity.collision.enabled=!1}}}else this.chessPickCallback(n.entity);else this.sendNukes()}},MousePick.prototype.update=function(e){if(null!==this.currentPicked){var t=(Date.now()-this.currentPickedStartTime)/1e3;if(t>this.duration)return this.isNuking||(this.currentPicked.rigidbody.enabled=!0,this.currentPicked.collision.enabled=!0),this.isNuking&&(this.currentPicked.render.enabled=!1,this.nukeTarget.render.enabled=!1),this.currentPicked=null,this.currentPickedCurve=null,void(this.currentPickedStartTime=null);var i=this.currentPickedCurve.value(t);if(this.currentPicked.setLocalPosition(i[0],i[1],i[2]),this.isNuking){var n=(new pc.Quat).copy(this.nukeOldRot).getEulerAngles();n.y=-180-n.y;var r=new pc.Quat;r.setFromEulerAngles(n);var s=(new pc.Quat).slerp(this.nukeOldRot,r,i[3]);this.currentPicked.setLocalRotation(s),i[3]>=.99&&(this.currentPicked.findByName("QB_smoke").enabled=!1,this.currentPicked.findByName("QB_blast").enabled=!0)}}},MousePick.prototype.sendNukes=function(){var e=pc.app.root.findByName("QB");e.findByName("QB_smoke").enabled=!0;var t=e.getLocalPosition();if(!(t.z>-3.7)){var i=pc.app.root.findByName("KW");this.isNuking=!0,this.nukeOldRot=(new pc.Quat).copy(e.getLocalRotation());var n=i.getLocalPosition();this.currentPickedCurve=new pc.CurveSet([[0,t.x,this.duration,n.x],[0,t.y,this.duration,n.y],[0,t.z,.5*this.duration,t.z+10,this.duration,t.z+1],[0,0,this.duration,1]]),this.currentPicked=e,this.currentPickedStartTime=Date.now(),this.nukeTarget=i,e.rigidbody.enabled=!1,e.collision.enabled=!1}};var Cinematic=pc.createScript("cinematic");Cinematic.prototype.initialize=function(){},Cinematic.prototype.update=function(i){};var EntityMove=pc.createScript("entityMove");EntityMove.prototype.initialize=function(){this.entityMove=!0,this.currentlyMoved={},this.timings=null,this.duration=null,this.jumpHeight=2},EntityMove.prototype.setChessAnimationDuration=function(t){null===this.duration&&(this.timings=[0,t/5,t],this.duration=t)},EntityMove.prototype.chessPieceMove=function(t,i){if("pieces"===t.parent.name){if(null===this.duration)throw new Exception("please set move duration");if(t.name in this.currentlyMoved&&null!==this.currentlyMoved[t.name])throw new Exception("moving piece that is already being moved");var e=t.getPosition(),n=[e,new pc.Vec3(e.x,e.y+this.jumpHeight,e.z),new pc.Vec3(i.x,i.y+this.jumpHeight,i.z)],o=new pc.CurveSet([[this.timings[0],n[0].x,this.timings[1],n[1].x,this.timings[2],n[2].x],[this.timings[0],n[0].y,this.timings[1],n[1].y,this.timings[2],n[2].y],[this.timings[0],n[0].z,this.timings[1],n[1].z,this.timings[2],n[2].z]]);this.currentlyMoved[t.name]={trajectoryCurve:o,startTime:Date.now(),entity:t},t.rigidbody.enabled=!1,t.collision.enabled=!1}},EntityMove.prototype.update=function(t){for(let t in this.currentlyMoved){var i=this.currentlyMoved[t];if(null!=i){var e=(Date.now()-i.startTime)/1e3;if(e>this.duration)i.entity.rigidbody.enabled=!0,i.entity.collision.enabled=!0,this.currentlyMoved[t]=null;else{var n=i.trajectoryCurve.value(e);i.entity.setPosition(n[0],n[1],n[2])}}}};