var Movement=pc.createScript("movement");Movement.attributes.add("speed",{type:"number",default:.1,min:.05,max:.5,precision:2,description:"Controls the movement speed"}),Movement.prototype.initialize=function(){this.force=new pc.Vec3},Movement.prototype.update=function(e){if(void 0!==this.entity.rigidbody){var t=0,s=0,i=0;if(this.app.keyboard.isPressed(pc.KEY_M),this.app.keyboard.isPressed(pc.KEY_LEFT)&&(t=-this.speed),this.app.keyboard.isPressed(pc.KEY_RIGHT)&&(t+=this.speed),this.app.keyboard.isPressed(pc.KEY_UP)&&(s=-this.speed),this.app.keyboard.isPressed(pc.KEY_DOWN)&&(s+=this.speed),this.app.keyboard.isPressed(pc.KEY_SPACE)&&this.entity.getPosition().y<.051&&(i=50*this.speed),this.force.x=t,this.force.z=s,this.force.length()){var o=Math.cos(.25*-Math.PI),p=Math.sin(.25*-Math.PI);this.force.set(this.force.x*o-this.force.z*p,0,this.force.z*o+this.force.x*p),this.force.length()>this.speed&&this.force.normalize().scale(this.speed)}this.force.y=i,this.entity.rigidbody.applyImpulse(this.force)}};var MainCameraController=pc.createScript("mainCameraController");MainCameraController.attributes.add("moveSpeed",{type:"number",default:.003}),MainCameraController.attributes.add("enableCinematic",{type:"boolean",default:!1}),MainCameraController.prototype.getDistance=function(t,e){var i=e.x-t.x,a=e.y-t.y,o=e.z-t.z;return Math.sqrt(i*i+a*a+o*o)},MainCameraController.prototype.initialize=function(){this.mouseDown=!1,this.camera=this.entity.camera,this.target=new pc.Vec3(0,0,0),this.scrollSpeed=.5,this.phi=Math.atan(this.entity.getPosition().x/this.entity.getPosition().z),this.startTime=Date.now(),this.hypotenuse=this.getDistance(new pc.Vec3(0,0,0),new pc.Vec3(this.entity.getPosition().x,0,this.entity.getPosition().z)),this.theta=Math.atan(this.entity.getPosition().y/this.hypotenuse),this.distance=this.getDistance(this.entity.getPosition(),this.target),this.enableCinematic&&(this.enableCinematic=!1,this.cinematicFlyInit(),setTimeout((()=>{this.startTime=Date.now(),this.enableCinematic=!0}),3e3)),this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onMouseDown,this),this.app.mouse.on(pc.EVENT_MOUSEUP,this.onMouseUp,this),this.app.mouse.on(pc.EVENT_MOUSEMOVE,this.onMouseMove,this),this.app.mouse.on(pc.EVENT_MOUSEWHEEL,this.onMouseWheel,this)},MainCameraController.prototype.onMouseDown=function(t){t.button===pc.MOUSEBUTTON_LEFT&&(this.mouseDown=!0)},MainCameraController.prototype.onMouseUp=function(t){t.button===pc.MOUSEBUTTON_LEFT&&(this.mouseDown=!1)},MainCameraController.prototype.onMouseMove=function(t){if(this.mouseDown){var e=t.dx,i=t.dy;this.theta+=i*this.moveSpeed;this.theta=pc.math.clamp(this.theta,-Math.PI/2,Math.PI/2),(this.phi-=e*this.moveSpeed)>-Math.phi&&(this.theta=pc.math.clamp(this.theta,-Math.PI/2,Math.PI/2)),this.updateCameraPosition(),this.entity.lookAt(0,0,0,0,1,0)}},MainCameraController.prototype.onMouseWheel=function(t){this.distance-=t.wheel*this.scrollSpeed,this.distance=pc.math.clamp(this.distance,1,100),this.updateCameraPosition()},MainCameraController.prototype.updateCameraPosition=function(){var t=this.distance*Math.sin(this.phi)*Math.cos(this.theta),e=this.distance*Math.sin(this.theta),i=this.distance*Math.cos(this.phi)*Math.cos(this.theta);this.entity.setPosition(this.target.x+t,this.target.y+e,this.target.z+i)},MainCameraController.prototype.cinematicFlyInit=function(){this.positionCurves=new pc.CurveSet([[0,-27.025,3,-7.38,4,-3.222,5,-3.203,6,1.323,7.5,2.8,9,1.748,10,1.924,11.5,-3.905,13,-11.151,14.5,0,16.5,0],[0,17.943,3,2.508,4,.944,5,.834,6,1,7.5,1.319,9,.846,10,.773,11.5,2.034,13,8.743,14.5,7,16.5,9],[0,-4.602,3,2.615,4,2.785,5,4.909,6,5.937,7.5,2.641,9,-3.444,10,-8.944,11.5,-10.661,13,-.192,14.5,7,16.5,9]]),this.positionCurves.type=pc.CURVE_SPLINE,this.rotationCurves=new pc.CurveSet([[0,153.66,3,157.26,4,174.79,5,-4.81,6,-11.61,7.5,-4.2,9,-2.8,10,-2.8,11.5,0,13,-40,14.5,-45,16.5,-50],[0,-86.72,3,-86.12,4,-47.11,5,-80.09,6,1.71,7.5,1.2,9,13.8,10,150,11.5,180,13,270,14.5,360,16.5,360],[0,-180,3,-180,4,-180,5,0,6,0,7.5,0,9,0,10,0,11.5,0,13,0,14.5,0,16.5,0]]),this.rotationCurves.type=pc.CURVE_SPLINE},MainCameraController.prototype.update=function(t){if(this.enableCinematic){var e=(Date.now()-this.startTime)/1e3;if(e>16.5)return void(this.enableCinematic=!1);var i=this.positionCurves.value(e),a=this.rotationCurves.value(e);this.entity.setPosition(i[0],i[1],i[2]),this.entity.setEulerAngles(a[0],a[1],a[2])}};var MousePick=pc.createScript("mousePick");const BUTTON_OPEN_DURATION=2;MousePick.prototype.initialize=function(){this.app.mouse.on(pc.EVENT_MOUSEDOWN,this.onSelect,this),this.app.mouse.disableContextMenu(),this.on("destroy",(function(){this.app.mouse.off(pc.EVENT_MOUSEDOWN,this.onSelect,this)}),this),this.currentPicked=null,this.currentPickedStartTime=null,this.currentPickedCurve=null,this.duration=5,this.mousePicker=!0,this.chessPickCallback=t=>{},this.isNuking=!1,this.nukeOldRot=null,this.openingButtonLid=null},MousePick.prototype.setChessPickCallback=function(t){this.chessPickCallback=t},MousePick.prototype.onSelect=function(t){if(t.button===pc.MOUSEBUTTON_LEFT){var e=this.entity.camera.screenToWorld(t.x,t.y,this.entity.camera.nearClip),i=this.entity.camera.screenToWorld(t.x,t.y,this.entity.camera.farClip),n=this.app.systems.rigidbody.raycastFirst(e,i);n?"Lid"!==n.entity.name?"BigRedButton"!==n.entity.name?"board"!==n.entity.parent.parent.name?"pieces"===n.entity.parent.name&&this.chessPickCallback(n.entity):this.chessPickCallback(n.entity):this.sendNukes(n.entity):this.openButton(n.entity):console.log("couldn't find raycast result")}},MousePick.prototype.update=function(t){if(null!==this.currentPicked){if((a=(Date.now()-this.currentPickedStartTime)/1e3)>this.duration)return this.isNuking?(this.currentPicked.render.enabled=!1,this.nukeTarget.render.enabled=!1):(this.currentPicked.rigidbody.enabled=!0,this.currentPicked.collision.enabled=!0,this.isNuking=!1),this.currentPicked=null,this.currentPickedCurve=null,void(this.currentPickedStartTime=null);var e=this.currentPickedCurve.value(a);if(this.currentPicked.setLocalPosition(e[0],e[1],e[2]),this.isNuking){this.currentPicked.findByName("smoke").enabled=!0;var i=this.currentPickedCurve.value(a-.001),n=new pc.Vec3(e[0]-i[0],e[1]-i[1],e[2]-i[2]);n=n.normalize();var r=(new pc.Quat).setFromDirections(new pc.Vec3(0,0,1),n);this.currentPicked.setLocalRotation(r),e[3]>=.99&&(this.currentPicked.findByName("smoke").enabled=!1,this.currentPicked.findByName("blast").enabled=!0)}}if(null!==this.openingButtonLid){var a;if((a=(Date.now()-this.openingButtonLid.curveStartTime)/1e3)>this.duration)return void(this.openingButtonLid=null);e=this.openingButtonLid.curve.value(a);var o=new pc.Quat(e[0],e[1],e[2],e[3]);this.openingButtonLid.setLocalRotation(o)}},MousePick.prototype.sendNukes=function(t){var e=null,i=null;"ButtonBlack"==t.parent.parent.name?(e="KB",i="KW"):(e="KW",i="KB");var n=pc.app.root.findByName(e),r=n.getLocalPosition();if(!(r.z>-3.7)){var a=pc.app.root.findByName(i);this.isNuking=!0,this.nukeOldRot=(new pc.Quat).copy(n.getLocalRotation());var o=a.getLocalPosition();this.currentPickedCurve=new pc.CurveSet([[0,r.x,.5*this.duration,.7*r.x+.3*o.x,this.duration,o.x],[0,r.y,.5*this.duration,.7*r.y+.3*o.y,this.duration,o.y],[0,r.z,.5*this.duration,r.z+10,this.duration,r.z+1],[0,0,this.duration,1]]),this.currentPickedCurve.type=pc.CURVE_SPLINE,this.currentPicked=n,this.currentPickedStartTime=Date.now(),this.nukeTarget=a,n.rigidbody.enabled=!1,n.collision.enabled=!1}},MousePick.prototype.openButton=function(t){console.log(pc.app.root.findByName("1").path);var e=pc.app.root.findByPath("Root/board/a/1").render;console.log(e.material),e.material.name.endsWith(".copy")||(e.material=e.material.clone(),e.material.name=e.material.name+".copy"),e.material.emissiveIntensity=1,e.material.update(),t=t.parent,this.openingButtonLid=t;var i=t.getLocalRotation(),n=new pc.Quat;n.setFromEulerAngles(90,0,0),t.curve=new pc.CurveSet([[0,i.x,1,n.x],[0,i.y,1,n.y],[0,i.z,1,n.z],[0,i.w,1,n.w]]),t.curveStartTime=Date.now()};var Cinematic=pc.createScript("cinematic");Cinematic.prototype.initialize=function(){},Cinematic.prototype.update=function(i){};var EntityMove=pc.createScript("entityMove");function isKnight(t){return"NB1"===t.name||"NB2"===t.name||"NW1"===t.name||"NW2"===t.name}EntityMove.prototype.initialize=function(){this.entityMove=!0,this.currentlyMoved={},this.timings=null,this.duration=null,this.jumpHeight=2},EntityMove.prototype.setChessAnimationDuration=function(t){null===this.duration&&(this.timings=[0,t/10,t],this.duration=t)},EntityMove.prototype.moveKnightTrajectory=function(t,i){var e=t.getPosition(),n=[e,new pc.Vec3(e.x,e.y+this.jumpHeight,e.z),new pc.Vec3(e.x,e.y+this.jumpHeight,i.z),new pc.Vec3(i.x,i.y+this.jumpHeight,i.z)];return this.timings[2]=2*this.duration/3,this.timings[3]=this.duration,new pc.CurveSet([[this.timings[0],n[0].x,this.timings[1],n[1].x,this.timings[2],n[2].x,this.timings[3],n[3].x],[this.timings[0],n[0].y,this.timings[1],n[1].y,this.timings[2],n[2].y,this.timings[3],n[3].y],[this.timings[0],n[0].z,this.timings[1],n[1].z,this.timings[2],n[2].z,this.timings[3],n[3].z]])},EntityMove.prototype.movePieceLinearTrajectory=function(t,i){var e=t.getPosition(),n=new pc.Vec3((e.x+i.x)/2,i.y+this.jumpHeight,(e.z+i.z)/2),s=[e,new pc.Vec3(e.x,e.y+this.jumpHeight/2,e.z),n,new pc.Vec3(i.x,i.y+this.jumpHeight/2,i.z),new pc.Vec3(i.x,e.y,i.z)],o=2*this.jumpHeight+Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.z-i.z,2)),h=this.jumpHeight/1.4/o;this.timings=[0,this.duration*h,this.duration/2,this.duration*(1-h),this.duration];var r=new pc.CurveSet([[this.timings[0],s[0].x,this.timings[1],s[1].x,this.timings[2],s[2].x,this.timings[3],s[3].x,this.timings[4],s[4].x],[this.timings[0],s[0].y,this.timings[1],s[1].y,this.timings[2],s[2].y,this.timings[3],s[3].y,this.timings[4],s[4].y],[this.timings[0],s[0].z,this.timings[1],s[1].z,this.timings[2],s[2].z,this.timings[3],s[3].z,this.timings[4],s[4].z]]);return r.type=pc.CURVE_SPLINE,r},EntityMove.prototype.getMovePieceTrajectory=function(t,i){return this.movePieceLinearTrajectory(t,i)},EntityMove.prototype.chessPieceMove=function(t,i){if("pieces"===t.parent.name){if(null===this.duration)throw new Exception("please set move duration");if(t.name in this.currentlyMoved&&null!==this.currentlyMoved[t.name])throw new Exception("moving piece that is already being moved");this.currentlyMoved[t.name]={trajectoryCurve:this.getMovePieceTrajectory(t,i),startTime:Date.now(),entity:t},t.rigidbody.enabled=!1,t.collision.enabled=!1}},EntityMove.prototype.update=function(t){for(let t in this.currentlyMoved){var i=this.currentlyMoved[t];if(null!=i){var e=(Date.now()-i.startTime)/1e3;if(e>this.duration)i.entity.rigidbody.enabled=!0,i.entity.collision.enabled=!0,this.currentlyMoved[t]=null;else{var n=i.trajectoryCurve.value(e);i.entity.setPosition(n[0],n[1],n[2])}}}};